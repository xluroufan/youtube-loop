<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Loop with Parameters</title>
    <script src="https://www.youtube.com/iframe_api"></script>
</head>
<body>
    <div id="player"></div>

    <script>
        var player;

        // IFrame APIが読み込まれた後に呼び出される関数
        function onYouTubeIframeAPIReady() {
            playYouTubeVideoWithParams(); // APIが準備できたら動画を再生
        }

        // URLのクエリパラメータから値を取得する関数
        function getQueryParams() {
            var params = {};
            var queryString = window.location.search.substring(1);
            var queries = queryString.split("&");
            queries.forEach(function(query) {
                var pair = query.split("=");
                params[pair[0]] = decodeURIComponent(pair[1]);
            });
            return params;
        }

        // クエリパラメータからID、開始時間、再生時間を取得して動画を再生
        function playYouTubeVideoWithParams() {
            var params = getQueryParams();
            var videoId = params.videoId;
            var startTime = parseInt(params.startTime, 10) || 0;
            var duration = parseInt(params.duration, 10) || 30;
            var endTime = startTime + duration;

            if (videoId) {
                if (player) {
                    player.loadVideoById({videoId: videoId, startSeconds: startTime});
                } else {
                    player = new YT.Player('player', {
                        height: '390',
                        width: '640',
                        videoId: videoId,
                        playerVars: {
                            'autoplay': 0,  // 自動再生を無効にする
                            'mute': 1       // ミュートで再生する場合
                        },
                        events: {
                            'onReady': function (event) {
                                setTimeout(function() {
                                    event.target.seekTo(startTime);
                                }, 1000); // 1秒の遅延を追加してシークを試みる
                            },
                            'onStateChange': function (event) {
                                if (event.data == YT.PlayerState.PLAYING) {
                                    checkTime(startTime, endTime);
                                }
                            }
                        }
                    });
                }
            } else {
                console.error("videoIdが指定されていません");
            }
        }

        // 動画の時間を監視してループ
        function checkTime(startTime, endTime) {
            var currentTime = player.getCurrentTime();
            if (currentTime >= endTime || currentTime < startTime) {
                player.seekTo(startTime);
            }
            setTimeout(function() { checkTime(startTime, endTime); }, 1000);
        }
    </script>
</body>
</html>
